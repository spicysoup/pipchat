(this.webpackJsonppipchat=this.webpackJsonppipchat||[]).push([[0],{115:function(e,t,n){e.exports={editor:"MessageEditor_editor__rBBL9","ql-toolbar":"MessageEditor_ql-toolbar__2rD8X"}},116:function(e,t,n){e.exports={peerList:"PeerList_peerList__2B12B"}},117:function(e,t,n){e.exports={messages:"Messages_messages__3AdIW"}},122:function(e,t,n){e.exports=n(290)},127:function(e,t,n){},22:function(e,t,n){e.exports={messageContainer:"Message_messageContainer__1vERf",message:"Message_message__2OMNI",self:"Message_self__1Oacy",peer:"Message_peer___pVeG"}},260:function(e,t){},261:function(e,t,n){},287:function(e,t){},290:function(e,t,n){"use strict";n.r(t);var r,a=n(0),c=n.n(a),s=n(30),o=n.n(s),i=(n(127),n(8)),u=(n(132),n(3)),l=n.n(u),p=n(9),f=n(20),d=n(109),b=n(110),v=n.n(b),m=function(){return window.history.replaceState({},document.title,window.location.pathname)},h=c.a.createContext(),y=function(){return Object(a.useContext)(h)},g="zxu.auth0.com",O="ta1r0JLa90qVQ9P3IvuHHb7geAPGiVLK",k="https://api.pipchat.knach.us",j=n(119),x=Object(j.a)(),w=n(292),_=n(293),E=n(294),P=n(47),K=n.n(P),S=n(295),B=n(66),C=n(17),N=n(111),L=n.n(N),A=function(e){return"production"===e?"https://pipchat-server.herokuapp.com":"http://localhost:3001"},T=function(){var e=Object(p.a)(l.a.mark((function e(t){var n,r,a,c;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=t.token,r=t.user,e.next=3,L.a.post("".concat(A("production"),"/api/checkin"),{user:r},{headers:{"Access-Control-Allow-Origin":"*","Content-Type":"application/json",Authorization:"Bearer ".concat(n)}});case 3:return a=e.sent,c=a.data,e.abrupt("return",c);case 6:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),U=Object(C.b)({name:"session",initialState:{peers:[],peer:null,user:null,token:null,keyPair:{}},reducers:{checkinStart:function(e){e.isLoading=!0},checkinFailure:function(e,t){e.isLoading=!1,e.error=t.payload},checkinSuccess:function(e,t){var n=t.payload;e.peers=n.peers,e.isLoading=!1,e.user=n.user,e.token=n.token},wsConnected:function(e){e.wsConnected=!0},choosePeer:function(e,t){var n=t.payload;e.peer=n},receivePeerList:function(e,t){var n=t.payload;e.peers=n.peers,e.peer=null},loginSuccess:function(e,t){t.payload},saveKeyPair:function(e,t){var n=t.payload;e.keyPair=n.keyPair},receivedPublicKey:function(e,t){var n=t.payload,r=n.peer,a=n.publicKey,c=e.peers.find((function(e){return e.id===r}));c&&(c.publicKey=a)}}}),R=U.actions,M=R.checkinStart,W=R.checkinFailure,q=R.checkinSuccess,F=R.wsConnected,J=R.choosePeer,I=(R.send,R.receivePeerList),D=R.loginSuccess,H=R.saveKeyPair,G=R.receivedPublicKey,V=function(e){var t=e.token,n=e.user;return(function(){var e=Object(p.a)(l.a.mark((function e(r){var a;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,r(M()),e.next=4,T({token:t,user:n});case 4:a=e.sent,r(q(Object(B.a)({},a,{token:t,user:n}))),e.next=11;break;case 8:e.prev=8,e.t0=e.catch(0),r(W(e.t0.toString()));case 11:case"end":return e.stop()}}),e,null,[[0,8]])})));return function(t){return e.apply(this,arguments)}}())},z=U.reducer,X=function(){var e=y(),t=e.isAuthenticated,n=e.loginWithRedirect,r=e.logout,s=e.getTokenSilently,o=e.user,u=Object(i.b)();return Object(a.useEffect)((function(){function e(){return(e=Object(p.a)(l.a.mark((function e(){var t;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,s();case 3:t=e.sent,u(V({token:t,user:o})),e.next=10;break;case 7:e.prev=7,e.t0=e.catch(0),console.error(e.t0);case 10:case"end":return e.stop()}}),e,null,[[0,7]])})))).apply(this,arguments)}o&&(console.log("User",o),u(D()),function(){return e.apply(this,arguments)}().then((function(e){return e})))}),[o]),c.a.createElement(w.a,null,c.a.createElement(_.a,{className:"".concat(K.a.navBar," mx-auto")},c.a.createElement(E.a,{xs:2}),c.a.createElement(E.a,{xs:8,className:K.a.title},"Welcome to PipChat"),c.a.createElement(E.a,{xs:2,className:"".concat(K.a.loginButton)},!t&&c.a.createElement(S.a,{variant:"outline-info",onClick:function(){return n({})}},"Log in"),t&&c.a.createElement(S.a,{variant:"outline-info",onClick:function(){return r()}},"Log out"))))},Q=n(48),Y=n.n(Q),$=n(114),Z=n.n($),ee=(n(259),n(12)),te=function(e){return Object(ee.encodeBase64)(Object(ee.decodeUTF8)(JSON.stringify(e)))},ne=function(e){var t=JSON.parse(Object(ee.encodeUTF8)(Object(ee.decodeBase64)(e)));return t.publicKey=new Uint8Array(Object.values(t.publicKey)),t.secretKey=new Uint8Array(Object.values(t.secretKey)),t},re=function(e){return new Uint8Array(Object.values(JSON.parse(Object(ee.encodeUTF8)(Object(ee.decodeBase64)(e)))))},ae=n(13),ce=function(e,t,n){var r=Object(ae.randomBytes)(ae.box.nonceLength),a=Object(ee.decodeUTF8)(JSON.stringify(t)),c=n?Object(ae.box)(a,r,n,e):ae.box.after(a,r,e),s=new Uint8Array(r.length+c.length);return s.set(r),s.set(c,r.length),Object(ee.encodeBase64)(s)},se=function(e,t,n){var r=Object(ee.decodeBase64)(t),a=r.slice(0,ae.box.nonceLength),c=r.slice(ae.box.nonceLength,t.length),s=n?ae.box.open(c,a,n,e):ae.box.open.after(c,a,e);if(!s)throw new Error("Could not decrypt message");var o=Object(ee.encodeUTF8)(s);return JSON.parse(o)},oe=Object(C.b)({name:"chat",initialState:{conversation:{}},reducers:{send:function(e,t){var n=t.payload;if("message"in n){var r=n.peer;r in e.conversation||(e.conversation[r]=[]),e.conversation[r].push(n)}},receive:function(e,t){var n=t.payload;if("message"in n){var r=n.self;r in e.conversation||(e.conversation[r]=[]),e.conversation[r].push(n)}}}}),ie=function(e,t){return e.session.peers.find((function(e){return e.id===t})).publicKey},ue=function(e){var t=e.session.keyPair;return ne(t).publicKey},le=function(e){var t=e.session.keyPair,n=ne(t);return{publicKey:n.publicKey,secretKey:n.secretKey}},pe=oe.actions,fe=pe.send,de=pe.receive,be=function(e){var t=e.peer;return(function(){var e=Object(p.a)(l.a.mark((function e(n,r){var a,c,s,o,i,u;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:a=r(),c=a.session,s=c.user.sub,o=c.keyPair,i=ne(o),u=i.publicKey,n(fe({self:s,peer:t,publicKey:te(u),request:"keyResponse"}));case 3:case"end":return e.stop()}}),e)})));return function(t,n){return e.apply(this,arguments)}}())},ve=function(e){var t=e.self,n=e.message,r=e.encrypted;return(function(){var e=Object(p.a)(l.a.mark((function e(a,c){var s,o,i;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:r&&(s=le(c()),o=s.secretKey,i=ie(c(),t),n=se(o,n,re(i))),a(de({self:t,message:n}));case 2:case"end":return e.stop()}}),e)})));return function(t,n){return e.apply(this,arguments)}}())},me=oe.reducer,he=n(115),ye=n.n(he),ge=(n(261),function(){var e=y().user,t=Object(i.c)((function(e){return e.session.peer})),n=Object(i.b)(),r=Object(a.useState)(""),s=Object(f.a)(r,2),o=s[0],u=s[1];return c.a.createElement(Z.a,{className:ye.a.editor,value:o,onChange:function(e){return u(e)},onKeyDown:function(r){"Enter"===r.key&&r.ctrlKey&&(r.preventDefault(),n(function(e){var t=e.self,n=e.peer,r=e.message;return(function(){var e=Object(p.a)(l.a.mark((function e(a,c){var s,o,i,u;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:s=le(c()),o=s.secretKey,i=ie(c(),n),console.log("public key: ",i),u=ce(o,r,re(i)),a(fe({self:t,peer:n,message:r,encryptedMessage:u}));case 5:case"end":return e.stop()}}),e)})));return function(t,n){return e.apply(this,arguments)}}())}({self:e.sub,peer:t,message:o})))},readOnly:!t})}),Oe=n(65),ke=n.n(Oe),je=function(e){var t=e.name,n=e.id,r=Object(i.b)(),a=Object(i.c)((function(e){return e.session.peer})),s=Object(i.c)((function(e){return e.session.user&&e.session.user.sub}));return c.a.createElement("div",{"data-id":n,className:"".concat(ke.a.peer," ").concat(n===a?ke.a.selected:""),onClick:function(){r(J(n)),r(function(e){var t=e.self,n=e.peer;return(function(){var e=Object(p.a)(l.a.mark((function e(r,a){var c;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:ie(a(),n)||(c=ue(a()),r(fe({self:t,peer:n,request:"keyRequest",publicKey:te(c)})));case 2:case"end":return e.stop()}}),e)})));return function(t,n){return e.apply(this,arguments)}}())}({self:s,peer:n}))}},t)},xe=n(116),we=n.n(xe),_e=function(e){var t=y().user,n=Object(i.c)((function(e){return e.session.peers.filter((function(e){return e.id!==t.sub}))}));return c.a.createElement("div",{className:we.a.peerList},n.map((function(e){return c.a.createElement(je,{key:e.id,name:e.name,id:e.id})})))},Ee=n(22),Pe=n.n(Ee),Ke=function(e){var t,n=Object(i.c)((function(e){return e.session.user&&e.session.user.sub})),r=e.data,a=r.self,s=r.message;return c.a.createElement("div",{className:"".concat(Pe.a.messageContainer," ").concat(n===a?Pe.a.self:Pe.a.peer)},c.a.createElement("div",{className:"".concat(Pe.a.message," ").concat(n===a?Pe.a.self:Pe.a.peer),dangerouslySetInnerHTML:(t=s,{__html:t})}))},Se=n(117),Be=n.n(Se),Ce=function(){var e=Object(i.c)((function(e){return e.session.peer})),t=Object(i.c)((function(t){return t.chat.conversation&&t.chat.conversation[e]||[]})),n=Object(a.useRef)();return Object(a.useEffect)((function(){n.current.scrollTop=n.current.scrollHeight}),[t]),c.a.createElement("div",{className:Be.a.messages,ref:n},t.map((function(t,n){return c.a.createElement(Ke,{key:"".concat(e,"-").concat(n),data:t})})))},Ne=function(){var e=y(),t=e.loading,n=e.user;return c.a.createElement("div",null,c.a.createElement(X,null),c.a.createElement(w.a,{className:Y.a.rootPane},t&&c.a.createElement("div",null,"Loading..."),!t&&c.a.createElement(_.a,null,c.a.createElement(E.a,null,n&&c.a.createElement(_e,null)),c.a.createElement(E.a,{xs:8},c.a.createElement(_.a,{className:Y.a.messages},c.a.createElement(Ce,null)),c.a.createElement(_.a,{className:Y.a.messageEditor},c.a.createElement(ge,null))))))},Le=n(120),Ae=n(46),Te=Object(C.b)({name:"counter",initialState:{value:0},reducers:{increment:function(e){e.value+=1},decrement:function(e){e.value-=1},incrementByAmount:function(e,t){e.value+=t.payload.amount}}}),Ue=Te.actions,Re=(Ue.increment,Ue.decrement,Ue.incrementByAmount,Te.reducer),Me=n(7),We=n(118),qe=n.n(We),Fe=l.a.mark(He),Je=l.a.mark(Ge),Ie=function(e){var t=e.self,n=e.peer,a=e.message,c=e.request,s=e.publicKey,o=e.encryptedMessage;o&&a&&(a=o),r.emit("chat/message",{self:t,peer:n,message:a,request:c,publicKey:s,encrypted:!!o})},De=function(){return Object(Ae.b)((function(e){return(r=qe()(A("production"))).on("connect",(function(){e(F())})),r.on("connect",(function(){setTimeout((function(){e(function(){var e=Object(p.a)(l.a.mark((function e(t,n){var r,a,c,s,o;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=n(),a=r.session,c=a.user,s=a.token,!c||!s){e.next=13;break}return e.prev=2,t(M()),e.next=6,T({token:s,user:c});case 6:o=e.sent,t(q(Object(B.a)({},o,{user:c,token:s}))),e.next=13;break;case 10:e.prev=10,e.t0=e.catch(2),t(W(e.t0.toString()));case 13:case"end":return e.stop()}}),e,null,[[2,10]])})));return function(t,n){return e.apply(this,arguments)}}())}),1e4*Math.random())})),r.on("welcome",(function(t){"peers"in t&&e(I(t))})),r.on("chat/message",(function(t){e(de(t))})),function(){r.close()}}))};function He(){var e,t,n,r,a,c;return l.a.wrap((function(s){for(;;)switch(s.prev=s.next){case 0:return s.next=2,Object(Me.b)(De);case 2:e=s.sent;case 3:return s.next=6,Object(Me.e)(e);case 6:t=s.sent,s.t0=t.type,s.next=s.t0===de.type?10:24;break;case 10:if(n=t.payload,r=n.self,a=n.request,c=n.publicKey,!a||!c){s.next=21;break}if("keyResponse"!==a){s.next=17;break}return s.next=15,Object(Me.d)(G({peer:r,publicKey:c}));case 15:s.next=19;break;case 17:return s.next=19,Object(Me.a)([Object(Me.d)(G({peer:r,publicKey:c})),Object(Me.d)(be({peer:r}))]);case 19:s.next=23;break;case 21:return s.next=23,Object(Me.a)([Object(Me.d)(J(r)),Object(Me.d)(ve(t.payload))]);case 23:return s.abrupt("break",26);case 24:return s.next=26,Object(Me.d)(t);case 26:s.next=3;break;case 28:case"end":return s.stop()}}),Fe)}function Ge(){var e,t;return l.a.wrap((function(n){for(;;)switch(n.prev=n.next){case 0:return n.next=3,Object(Me.e)([q,fe]);case 3:if((e=n.sent).type!==q.type){n.next=8;break}return t=e.payload.user,n.next=8,Object(Me.b)(Ie,{self:t.sub});case 8:if(e.type!==fe.type){n.next=11;break}return n.next=11,Object(Me.b)(Ie,e.payload);case 11:n.next=0;break;case 13:case"end":return n.stop()}}),Je)}var Ve=n(31),ze=l.a.mark(Xe);function Xe(){var e,t;return l.a.wrap((function(n){for(;;)switch(n.prev=n.next){case 0:return n.next=3,Object(Ve.e)([D]);case 3:return n.sent,console.log("Login success. Generate key pair now."),e=ae.box.keyPair(),t=te(e),n.next=9,Object(Ve.d)(H({keyPair:t}));case 9:n.next=0;break;case 11:case"end":return n.stop()}}),ze)}var Qe=l.a.mark(Ye);function Ye(){return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,Object(Me.a)([Object(Me.c)(He),Object(Me.c)(Ge),Object(Me.c)(Xe)]);case 2:case"end":return e.stop()}}),Qe)}var $e=Object(Ae.a)(),Ze=[].concat(Object(Le.a)(Object(C.c)({thunk:!0})),[$e]),et=Object(C.a)({reducer:{counter:Re,session:z,chat:me},middleware:Ze});$e.run(Ye);Boolean("localhost"===window.location.hostname||"[::1]"===window.location.hostname||window.location.hostname.match(/^127(?:\.(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)){3}$/));o.a.render(c.a.createElement(i.a,{store:et},c.a.createElement((function(e){var t=e.children,n=e.onRedirectCallback,r=void 0===n?m:n,s=Object(d.a)(e,["children","onRedirectCallback"]),o=Object(a.useState)(),i=Object(f.a)(o,2),u=i[0],b=i[1],y=Object(a.useState)(),g=Object(f.a)(y,2),O=g[0],k=g[1],j=Object(a.useState)(),x=Object(f.a)(j,2),w=x[0],_=x[1],E=Object(a.useState)(!0),P=Object(f.a)(E,2),K=P[0],S=P[1],B=Object(a.useState)(!1),C=Object(f.a)(B,2),N=C[0],L=C[1];Object(a.useEffect)((function(){(function(){var e=Object(p.a)(l.a.mark((function e(){var t,n,a,c,o;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,v()(s);case 2:if(t=e.sent,_(t),!window.location.search.includes("code=")||!window.location.search.includes("state=")){e.next=10;break}return e.next=7,t.handleRedirectCallback();case 7:n=e.sent,a=n.appState,r(a);case 10:return e.next=12,t.isAuthenticated();case 12:if(c=e.sent,b(c),!c){e.next=19;break}return e.next=17,t.getUser();case 17:o=e.sent,k(o);case 19:S(!1);case 20:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}})()()}),[]);var A=function(){var e=Object(p.a)(l.a.mark((function e(){var t,n,r=arguments;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=r.length>0&&void 0!==r[0]?r[0]:{},L(!0),e.prev=2,e.next=5,w.loginWithPopup(t);case 5:e.next=10;break;case 7:e.prev=7,e.t0=e.catch(2),console.error(e.t0);case 10:return e.prev=10,L(!1),e.finish(10);case 13:return e.next=15,w.getUser();case 15:n=e.sent,k(n),b(!0);case 18:case"end":return e.stop()}}),e,null,[[2,7,10,13]])})));return function(){return e.apply(this,arguments)}}(),T=function(){var e=Object(p.a)(l.a.mark((function e(){var t;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return S(!0),e.next=3,w.handleRedirectCallback();case 3:return e.next=5,w.getUser();case 5:t=e.sent,S(!1),b(!0),k(t);case 9:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}();return c.a.createElement(h.Provider,{value:{isAuthenticated:u,user:O,loading:K,popupOpen:N,loginWithPopup:A,handleRedirectCallback:T,getIdTokenClaims:function(){return w.getIdTokenClaims.apply(w,arguments)},loginWithRedirect:function(){return w.loginWithRedirect.apply(w,arguments)},getTokenSilently:function(){return w.getTokenSilently.apply(w,arguments)},getTokenWithPopup:function(){return w.getTokenWithPopup.apply(w,arguments)},logout:function(){return w.logout.apply(w,arguments)}}},t)}),{domain:g,client_id:O,redirect_uri:window.location.origin,audience:k,onRedirectCallback:function(e){x.push(e&&e.targetUrl?e.targetUrl:window.location.pathname)}},c.a.createElement(Ne,null))),document.getElementById("root")),"serviceWorker"in navigator&&navigator.serviceWorker.ready.then((function(e){e.unregister()}))},47:function(e,t,n){e.exports={navBar:"NavBar_navBar__q71r5",title:"NavBar_title__1BjYi",loginButton:"NavBar_loginButton__28HF0"}},48:function(e,t,n){e.exports={rootPane:"App_rootPane__3W_gX",messages:"App_messages__2Pn3D",messageEditor:"App_messageEditor__3bDhA"}},65:function(e,t,n){e.exports={peer:"Peer_peer__1k_jk",selected:"Peer_selected__3jvM4"}}},[[122,1,2]]]);
//# sourceMappingURL=main.f7489e9a.chunk.js.map